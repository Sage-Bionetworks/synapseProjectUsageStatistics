---
output: 
  html_document: 
    keep_md: yes
params:
  projectId: !r 'syn1773109'
  nMonths: 6
  useTeamGrouping: TRUE
  aclTeamOrder: !r c(3346847, 'syn1773109')
---

```{r libs, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(synapseClient)
library(RMySQL)
library(yaml)

source("lib.R")

synapseLogin()

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  fig.width=20)


# qTemplate <- 'select CLIENT,ENTITY_ID,AR.TIMESTAMP,DATE,USER_ID,NODE_TYPE,N.NAME from ACCESS_RECORD AR, PROCESSED_ACCESS_RECORD PAR, NODE_SNAPSHOT N, (select distinct ID from NODE_SNAPSHOT where PROJECT_ID = %s) NODE where MONTH(FROM_UNIXTIME(AR.TIMESTAMP/1000))=%s AND YEAR(FROM_UNIXTIME(AR.TIMESTAMP/1000))=%s and AR.RESPONSE_STATUS=200 AND AR.SESSION_ID = PAR.SESSION_ID and AR.TIMESTAMP = PAR.TIMESTAMP and PAR.ENTITY_ID = NODE.ID and N.ID = NODE.ID and (PAR.NORMALIZED_METHOD_SIGNATURE = "GET /entity/#/file" or PAR.NORMALIZED_METHOD_SIGNATURE = "GET /entity/#/version/#/file");'

qTemplate <- 'select CLIENT,ENTITY_ID,AR.TIMESTAMP,DATE,USER_ID,NODE_TYPE,N.NAME from ACCESS_RECORD AR, PROCESSED_ACCESS_RECORD PAR, NODE_SNAPSHOT N, PROJECT_STATS.%s NODE where MONTH(FROM_UNIXTIME(AR.TIMESTAMP/1000))=%s AND YEAR(FROM_UNIXTIME(AR.TIMESTAMP/1000))=%s and (AR.RESPONSE_STATUS IN (200, 307)) AND AR.SESSION_ID = PAR.SESSION_ID and AR.TIMESTAMP = PAR.TIMESTAMP and PAR.ENTITY_ID = NODE.ID and N.ID = NODE.ID AND N.TIMESTAMP = NODE.TIMESTAMP and (PAR.NORMALIZED_METHOD_SIGNATURE IN ("GET /entity/#/file", "GET /entity/#/version/#/file"));'

```

```{r config}
config <- yaml.load_file("~/datawarehouse_config.yml")

projectId <- gsub("syn", "", params$projectId)
nMonths <- params$nMonths
useTeamGrouping <- params$useTeamGrouping
aclTeamOrder <- params$aclTeamOrder

con <- dbConnect(MySQL(),
                 user = config$username,
                 password = config$password,
                 host = config$host,
                 dbname='warehouse')

timestampBreaksDf <- makeDateBreaks(nMonths)
```


```{r domysqlquery}
queryData <- getData(con=con, qTemplate=qTemplate, projectId=projectId,
                     timestampBreaksDf=timestampBreaksDf)
```

### Usage from `r min(timestampBreaksDf$date)` to `r max(timestampBreaksDf$date)`.

```{r users}
if (useTeamGrouping) {
  aclUserList <- processAclUserList(projectId, aclTeamOrder)
} else {
  aclUserList <- NULL
}
```

```{r summaryuseraccess}
allUsers <- getQueryUserProfiles(queryData, useTeamGrouping, aclUserList)
```

```{r userJoin}
queryData <- queryData %>% left_join(., allUsers)
```

#### Total Users
There are `r length(setdiff(unique(queryData$userName), c("anonymous")))` users downloading files in this time period. 

#### Returning users
`r multiMonthVisits(queryData) %>% nrow` users have downloaded a file in at least two different months.

#### New users (per month, starting from first month in the range):
```{r}
firstMonthToVisit(queryData) %>% knitr::kable()
```

#### Unique users (per month, starting from first month in the range):
```{r}
uniqueUsersPerMonth(queryData) %>% knitr::kable()
```

#### Downloads per month
```{r loadpermonth}
dateGroupingCount <- countByMonth(queryData, useTeamGrouping)
dateGroupingCount %>% knitr::kable()
```

#### Downloads per day
```{r loadperday}
perdayCount <- countByDay(queryData, useTeamGrouping)
```

```{r plotperday, fig.width=20, fig.height=6, include=TRUE, eval=TRUE}
### Per day usage, total
plotByDay(perdayCount, useTeamGrouping)
```

#### Downloads per user (top 20 users)
```{r peruser}
topNEntities(queryData, allUsers, 20) %>% knitr::kable(row.names=TRUE)
```

#### Download counts ($\geq 5$)
```{r include=TRUE, eval=TRUE}
### Data
dataaccessCount <- queryData %>%
  dplyr::count(id, NAME, NODE_TYPE, dateGrouping) %>% 
  dplyr::filter(n > 5, !stringr::str_detect(id, "acl")) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(dplyr::desc(n)) %>% 
  reshape2::dcast(id + NAME + NODE_TYPE ~ dateGrouping, value.var='n') %>% 
  knitr::kable()

# dataaccessCount %>% 
#   dplyr::select(id, NAME, NODE_TYPE, n) %>% 
#   knitr::kable()
```