---
output: 
  html_document: 
    keep_md: yes
params:
  projectId: !r 'syn1773109'
  nMonths: 6
  useTeamGrouping: TRUE
  aclTeamOrder: !r c("3319054", "2224090", "syn1773109", "273957")
---

```{r libs, echo=FALSE, warning=FALSE, message=FALSE}
library(plyr)
library(dplyr)
library(reshape)
library(data.table)
library(xtable)
library(knitr)
library(ggplot2)
library(scales)
library(stringr)
library(synapseClient)
library(RMySQL)
library(yaml)
library(lubridate)

source("lib.R")

synapseLogin()

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  fig.width=20)

mytheme <- theme_bw() + theme(axis.text=element_text(size=16),
                              axis.title.x=element_text(size=18),
                              axis.title.y=element_text(size=18, angle=90))

```
```{r config}
source("config.R")

qTemplate <- 'select CLIENT,NORMALIZED_METHOD_SIGNATURE,PROJECT_ID,BENEFACTOR_ID,PARENT_ID,ENTITY_ID,AR.TIMESTAMP,RESPONSE_STATUS,DATE,USER_ID,NODE_TYPE,N.NAME from ACCESS_RECORD AR, PROCESSED_ACCESS_RECORD PAR, NODE_SNAPSHOT N, (select distinct ID from NODE_SNAPSHOT where PROJECT_ID = "%s") NODE where AR.TIMESTAMP Between %s AND %s and AR.SESSION_ID = PAR.SESSION_ID and AR.TIMESTAMP = PAR.TIMESTAMP and PAR.ENTITY_ID = NODE.ID and N.ID = NODE.ID and (PAR.NORMALIZED_METHOD_SIGNATURE = "GET /entity/#/file" or PAR.NORMALIZED_METHOD_SIGNATURE = "GET /entity/#/version/#/file");'

```

```{r domysqlquery}
queryData <- getData(con=con, qTemplate=qTemplate, projectId=projectId,
                     timestampBreaksDf=timestampBreaksDf)
```
### Downloads usage statistics from `r min(monthBreaksDf$beginTime)` to `r max(monthBreaksDf$endTime)`.

```{r users}
if (useTeamGrouping) {
  aclUserList <- processAclUserList(projectId, aclTeamOrder)
} else {
  aclUserList <- NULL
}
```

```{r summaryuseraccess}
allUsers <- getQueryUserProfiles(queryData, useTeamGrouping, aclUserList)
```

```{r userJoin}
queryData <- queryData %>% left_join(., allUsers)
```

#### Downloads per month
```{r loadpermonth}
dateGroupingCount <- countByMonth(queryData, useTeamGrouping)
dateGroupingCount %>% kable
```

#### Downloads per day
```{r loadperday}
perdayCount <- countByDay(queryData, useTeamGrouping)
```

```{r plotperday, fig.width=20, fig.height=6, include=TRUE, eval=TRUE}
### Per day usage, total
plotByDay(queryData, useTeamGrouping)
```
```{r include=TRUE, eval=TRUE}
### Users
useraccessCount <- queryData %>% 
  count(userName, userId, teamId, teamName) %>% 
  ungroup() %>%
  arrange(n) %>%
  mutate(userName=reorder(userName, n, order=TRUE),
         userId=reorder(userId, n, order=TRUE))
```

#### Downloads per user (top 20 users)
```{r peruser}
plotdata <- queryData %>%
  count(userName) %>%
  # filter(n > 1) %>% 
  ungroup() %>% 
  left_join(allUsers) %>% 
  mutate(userName=reorder(userName, n, ordered=TRUE))

plotdata %>% top_n(20, n)  %>% arrange(-n) %>% select(n) %>% kable(row.names=TRUE)
```

#### Entity downloads ($\geq 5$)
```{r include=TRUE, eval=TRUE}
### Data
dataaccessCount <- queryData %>%
  count(id, NAME, NODE_TYPE) %>% 
  filter(n > 5, !str_detect(id, "acl")) %>%
  ungroup() %>% 
  arrange(desc(n))
dataaccessCount %>% select(id, NAME, NODE_TYPE, n) %>% kable
```